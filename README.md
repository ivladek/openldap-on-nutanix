# Ubuntu VM automated deployment with OpenLDAP inside over Nutanix Prism Central

This script for deployment of VM with Ubuntu, using Nutanix RestAPI, and install OpenLDAP inside it using cloud-Init.

This project contains a lot of files. Five of them are important:
- **create-vm.sh** - main script
- **config/script.cfg** - internal config data
- **config/sample.cfg** - user input, create user.cfg file for your own data
- **template/user-data_template** - template user-data(.yaml) file for cloud-init
- **template/vm-data_template** - template vm-data.json file for RestAPI call to Nutanix API

Some of input data should be collected from Nutanix Prism Central (PC) and Prism Element (PE):
- cluster name and uuid: ssh to Nutanix PC VIP and use "```console
ncli multicluster get-cluster-state
```"
- image uuid - ssh to Nutanix PE VIP and use "```console
acli image.list
```"
- network name and uuid - ssh to Nutanix PE VIP and use "```console
acli image.list
```"

You must use the network with IP Address Management. This is important because you could not pass the static IP via user-data part of cloud-init. The meta-data are prepared by Nutanix PC internally and based on data defined in IPAM for the network.

The constructions like **{{VARname}}** in two templates are represented a variable to substitute via values by described script.

Other files are generated by this script and placed here to show intermediate results. I think they wuold be helpful to better understanding hot it works.

The script's steps are:
    lines 13–45   - Loading the user data from file like above
    lines 47–96   - Preparation files to include into user-data
    lines 98–105  - Encoding prepared files with base64
    lines 107–129 - Generation user-data from template and encode its content with base64
    lines 131–148 - Generation user-data from template and encode its content with base64
    lines 161–170 - Generation the target script file, which makes call to Nutanix API to create VM and deploy software inside it
    lines 172–177 - Just say goodbye :)

Directories in this repo:
- **config** - for configuration data
- **templates** - for user-data and vm-data templates
- **output** - all intermediate files

The result is **output\pc-vm-create.sh**
